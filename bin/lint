#!/usr/bin/env node

var fs = require('fs');
var util = require('util');
var path = require('path');
var inspect = util.inspect;
var program = require('commander');

var walk = require('walk');

var linter = require('..');
var formatAsOneline = require('../lib/linter_report');

program
    .version(require('../package.json').version)
    .option('--oneline', 'SublimeLinter-compatible output')
    .option('--json', 'JSON output')
    .usage('<file ...>')
    .parse(process.argv);

var filepath = program.args[0];

var extenstions = {
    '.inc': 1,
    '.tmpl': 1
};

function output(report, filepath) {
    if (program.oneline) {
        if (report.length > 0) {
            console.log(
                formatAsOneline(report, filepath)
            );
        }

        return;
    }

    if (program.json) {
        console.log(
            JSON.stringify(report, null, 4)
        );

        return;
    }

    console.log(
        inspect(report, { colors: true, depth: Infinity })
    );
}

var walker = walk.walk(filepath, { followLinks: false });

walker
.on('file', function(root, fileStats, next) {
    var extenstion = path.extname(fileStats.name);

    if (!extenstions[extenstion]) {
        return next();
    }

    var fullPath = path.join(root, fileStats.name);

    linter(fs.readFileSync(fullPath, 'utf8'), function(res) {
        output(res, fullPath);
        next();
    });
})
.on('errors', function(root, nodeStatsArray, next) {
    console.error(nodeStatsArray);
    next();
});
