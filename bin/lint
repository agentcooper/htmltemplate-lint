#!/usr/bin/env node

var fs = require('fs');
var util = require('util');
var path = require('path');
var inspect = util.inspect;
var program = require('commander');

var walk = require('walk');

var linter = require('..');
var linterReport = require('../lib/linter_report');

program
    .version(require('../package.json').version)
    .option('--oneline', 'SublimeLinter-compatible output')
    .usage('<file ...>')
    .parse(process.argv);

var filepath = program.args[0];

var extenstions = {
    '.inc': 1,
    '.tmpl': 1
};

function output(res, filepath) {
    if (program.oneline) {
        console.log(
            linterReport(res, filepath)
        );
    } else {
        console.log(
            inspect(res, { colors: true, depth: Infinity })
        );
    }
}

var walker = walk.walk(filepath, { followLinks: false });

walker
.on('file', function(root, fileStats, next) {
    var extenstion = path.extname(fileStats.name);

    if (!extenstions[extenstion]) {
        return next();
    }

    var fullPath = path.join(root, fileStats.name);

    linter(fs.readFileSync(fullPath, 'utf8'), function(res) {
        output(res, fullPath);
        next();
    });
})
.on('errors', function(root, nodeStatsArray, next) {
    console.error(nodeStatsArray);
    next();
});

function printError(message, error) {
    console.log('');
    console.log('  error: ' + message);

    if (error) {
        console.log('');
        console.log('  ' + error.toString());
    }

    console.log('');
}
